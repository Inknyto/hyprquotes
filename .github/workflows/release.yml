# ~/Documents/git/hyprquotes/.github/workflows/release.yml 20 Feb at 03:14:25 AM
name: Release

on:
  push:
    tags:
      - 'v*.*.*'   # triggers on v1.0.0, v1.2.3, etc.

permissions:
  contents: write  # needed to create GitHub Releases

jobs:
  release:
    name: Build & publish release
    runs-on: ubuntu-latest

    steps:
      # ── 1. Checkout ──────────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2. Derive version from tag ───────────────────────────────────────
      - name: Set version
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"
        # GITHUB_REF_NAME = "v1.0.0" → VERSION = "1.0.0"

      # ── 3. Build release tarball ─────────────────────────────────────────
      #
      #   Structure inside the archive:
      #     hyprquotes-1.0.0/
      #     ├── hyprquotes.py
      #     ├── install.sh
      #     ├── uninstall.sh
      #     ├── README.md
      #     ├── LICENSE
      #     ├── requirements.txt
      #     └── assets/
      #         └── programming-quotes.json
      #
      - name: Build tarball
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          DIST="hyprquotes-${VERSION}"
          mkdir -p "${DIST}/assets"

          cp hyprquotes.py   "${DIST}/"
          cp workflow/install.sh      "${DIST}/"
          cp workflow/uninstall.sh    "${DIST}/"
          cp README.md       "${DIST}/"
          cp LICENSE         "${DIST}/"
          cp requirements.txt "${DIST}/"
          cp assets/programming-quotes.json "${DIST}/assets/"

          chmod +x "${DIST}/install.sh" "${DIST}/uninstall.sh"

          tar -czf "hyprquotes-${VERSION}-linux.tar.gz" "${DIST}"

          # Generate SHA-256 checksum
          sha256sum "hyprquotes-${VERSION}-linux.tar.gz" \
            > "hyprquotes-${VERSION}-linux.tar.gz.sha256"

      # ── 4. Extract changelog for this tag ────────────────────────────────
      #   Expects a CHANGELOG.md with headings like "## [1.0.0] - 2025-01-27"
      #   Falls back to a generic message if none found.
      - name: Extract release notes
        id: notes
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          if [[ -f CHANGELOG.md ]]; then
            # Grab the block between this version heading and the next
            NOTES=$(awk "/^## \[${VERSION}\]/{found=1; next} found && /^## \[/{exit} found{print}" CHANGELOG.md)
          fi
          if [[ -z "${NOTES:-}" ]]; then
            NOTES="See [README](https://github.com/${{ github.repository }}/blob/main/README.md) for details."
          fi
          # Write to file to avoid quoting issues
          echo "$NOTES" > release_notes.md

      # ── 5. Create GitHub Release ─────────────────────────────────────────
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "hyprquotes v${{ steps.version.outputs.VERSION }}"
          body_path: release_notes.md
          files: |
            hyprquotes-${{ steps.version.outputs.VERSION }}-linux.tar.gz
            hyprquotes-${{ steps.version.outputs.VERSION }}-linux.tar.gz.sha256
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          # tags like v1.0.0-beta.1 are automatically marked as pre-release
